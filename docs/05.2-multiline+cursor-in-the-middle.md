# Phase 5.2 ‚Äî Multiline + Cursor-in-the-Middle

## Step 1: Extend `CompletionContext` (minimal, correct)

### Why suffix belongs here

Conceptually, a completion context is:

```
[prefix][CURSOR][suffix]
```

Right now you only model the left side.
Inline completion *cannot be correct* without knowing what‚Äôs on the right.

---

## 1Ô∏è‚É£ Update the dataclass

Add **one field**, nothing else for now.

```python
from typing import List


class CompletionContext:
    language: str
    file_path: str

    prefix: str           # text before cursor (same line)
    suffix: str           # üîß NEW: text after cursor (same line)

    current_line: str     # full line
    previous_lines: List[str]
    next_lines: List[str]

    indentation: str
    line: int
    character: int
```

That‚Äôs it.
No behavioral change yet.

---

## 2Ô∏è‚É£ Populate `suffix` in `context_builder`

You already have everything you need.

Where you currently do something like:

```python
line_text = document.lines[line]
prefix = line_text[:character]
```

Add:

```python
suffix = line_text[character:]
```

So the builder becomes (simplified):

```python
line_text = document.lines[line]

prefix = line_text[:character]
suffix = line_text[character:]

context = CompletionContext(
    language=document.language_id,
    file_path=document.path,
    prefix=prefix,
    suffix=suffix,              # üîß HERE
    current_line=line_text,
    previous_lines=previous,
    next_lines=next_,
    indentation=indent,
    line=line,
    character=character,
)
```

Nothing else changes.

---

## 3Ô∏è‚É£ Why this does NOT break anything

* Existing agents ignore `suffix` ‚Üí fine
* PrefixAlignmentAgent still works ‚Üí fine
* Prompt still works ‚Üí fine
* LSP edits still work ‚Üí fine

This is a **pure capability upgrade**.

---

# Phase 5.3 ‚Äî Upgrade PrefixAlignmentAgent (cursor-aware)

Now we make the agent *actually powerful*.

## What we want to fix

### Case 1 ‚Äî Cursor in the middle

```php
$a = |foo();
```

Model returns:

```php
$a = bar();
```

Correct result:

```php
$a = bar();
```

### Case 2 ‚Äî Overlapping suffix

```python
print(|value)
```

Model returns:

```python
value)
```

Correct result:

```python
print(value)
```

---

## 4Ô∏è‚É£ Upgrade the agent logic (still string-based)

Update `PrefixAlignmentAgent.after_generation`:

```python
def after_generation(
    self,
    context: CompletionContext,
    text: str,
) -> str | None:
    completion = text or ""

    # Step 1: remove duplicated prefix (existing logic)
    completion = strip_prefix_echo(
        context.prefix,
        context.current_line,
        completion,
    )

    # Step 2: remove duplicated suffix
    suffix = context.suffix.strip()
    if suffix and completion.rstrip().endswith(suffix):
        completion = completion[: -len(suffix)].rstrip()

    return completion
```

This handles:

* cursor in the middle
* overlapping tokens
* single-line duplication

No ASTs, no tokenizers, no magic.

---

## 5Ô∏è‚É£ Important note about multiline (next step)

This **intentionally** does NOT yet handle:

* multiline suffix overlap
* indentation normalization across lines
* block completion trimming

That‚Äôs Phase **5.4**, and it builds directly on this.

You‚Äôre doing this in the right order.

---

## 6Ô∏è‚É£ TextEdit still remains correct

Your edit range stays:

```python
start.character = len(prefix)
end.character = len(current_line)
```

Because:

* suffix duplication is removed in the agent
* edit replaces everything right of cursor

This keeps Blink happy and predictable.

---

## Sanity check: why this design is solid

* ‚úÖ Context owns text reality
* ‚úÖ Agents own semantic correctness
* ‚úÖ Engine owns orchestration
* ‚úÖ LSP owns application

This is a *textbook clean separation*.

---

## Next (your choice)

We can now proceed to **one** of these:

1. **Phase 5.4 ‚Äî Multiline alignment**

   * overlapping blocks
   * indentation reflow
   * brace-aware trimming

2. **Agent-based ranking**

   * generate 2‚Äì3 variants
   * choose best via heuristics

3. **Cancellation-aware streaming**

   * stop Ollama when Blink cancels

If you want my recommendation:
üëâ **Multiline alignment next** ‚Äî it unlocks real-world usability immediately.

Just say the word.
